name: CI for XAMPP Web Server
 
on:
  push:
    branches: [ "main" ]
  workflow_dispatch:   # allow manual trigger
 
jobs:
  build:
    name: Build Stage - Checkout Repositories
    runs-on: self-hosted
 
    steps:
      - name: Checkout Repo A (current DevOps2025)
        uses: actions/checkout@v3

      - name: Checkout Repo B (champ_private via GitHub deploy key)
        uses: actions/checkout@v3
        with:
          repository: Manoj9923/champ_private
          ssh-key: ${{ secrets.SSH_PRIVATE_KEY_REPO1_ACCESS }}   # ðŸ‘ˆ deploy key for GitHub
          ref: main
          path: web
          persist-credentials: false
          ssh-strict: false
 
      - name: Archive Website Code
        run: |
          tar -czf website.tar.gz -C web .
 
      - name: Upload Website Artifact
        uses: actions/upload-artifact@v4
        with:
          name: website-code
          path: website.tar.gz
  deploy:
    name: Deploy Stage - Transfer to XAMPP Server
    runs-on: self-hosted
    needs: build

    steps:
     - name: Download Website Artifact
       uses: actions/download-artifact@v4
       with:
        name: website-code
        path: .

     - name: Extract Artifact
       run: |
         tar -xzf website.tar.gz

    # Step 1: Upload files to user's home dir
     - name: Copy Files to XAMPP Server via SSH
       run: |
          echo "${{ secrets.SERVER_SSH_KEY_RUNNERVM }}" > private_key.pem
          chmod 600 private_key.pem
          scp -i private_key.pem -o StrictHostKeyChecking=no -r * ${{ secrets.USERNAME }}@${{ secrets.HOST }}:/opt/lampp/htdocs/
 
     - name: Restart Apache in XAMPP
       run: |
          ssh -i private_key.pem -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
            "sudo /opt/lampp/lampp restartapache"
 
  test:
    name: Test Stage - Validate Website
    runs-on: self-hosted
    needs: deploy
 
    steps:
      - name: Wait for Web Server
        run: sleep 10
 
      - name: Test Website URL
        run: |
          curl -I http://${{ secrets.HOST }} | grep "200 OK" || exit 1
